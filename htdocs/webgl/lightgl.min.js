var GL=function(){var e,A={create:function(b){b=b||{};var c=document.createElement("canvas");c.width=800,c.height=600,"alpha"in b||(b.alpha=!1);try{e=c.getContext("webgl",b)}catch(a){}try{e=e||c.getContext("experimental-webgl",b)}catch(a){}if(!e)throw new Error("WebGL not supported");return e.HALF_FLOAT_OES=36193,Q(),R(),S(),T(),e},keys:{},Matrix:p,Indexer:E,Buffer:F,Mesh:w,HitTest:B,Raytracer:C,Shader:I,Texture:u,Vector:k};function Q(){e.MODELVIEW=L|1,e.PROJECTION=L|2;var b=new p(),c=new p();e.modelviewMatrix=new p(),e.projectionMatrix=new p();var a=[],d=[],f,g;e.matrixMode=function(h){switch(h){case e.MODELVIEW:f="modelviewMatrix",g=a;break;case e.PROJECTION:f="projectionMatrix",g=d;break;default:throw new Error("invalid matrix mode "+h)}},e.loadIdentity=function(){p.identity(e[f])},e.loadMatrix=function(h){for(var i=h.m,n=e[f].m,j=0;j<16;j++)n[j]=i[j]},e.multMatrix=function(h){e.loadMatrix(p.multiply(e[f],h,c))},e.perspective=function(h,i,n,j){e.multMatrix(p.perspective(h,i,n,j,b))},e.frustum=function(h,i,n,j,l,m){e.multMatrix(p.frustum(h,i,n,j,l,m,b))},e.ortho=function(h,i,n,j,l,m){e.multMatrix(p.ortho(h,i,n,j,l,m,b))},e.scale=function(h,i,n){e.multMatrix(p.scale(h,i,n,b))},e.translate=function(h,i,n){e.multMatrix(p.translate(h,i,n,b))},e.rotate=function(h,i,n,j){e.multMatrix(p.rotate(h,i,n,j,b))},e.lookAt=function(h,i,n,j,l,m,q,o,r){e.multMatrix(p.lookAt(h,i,n,j,l,m,q,o,r,b))},e.pushMatrix=function(){g.push(Array.prototype.slice.call(e[f].m))},e.popMatrix=function(){var h=g.pop();e[f].m=M?new Float32Array(h):h},e.project=function(h,i,n,j,l,m){j=j||e.modelviewMatrix,l=l||e.projectionMatrix,m=m||e.getParameter(e.VIEWPORT);var q=l.transformPoint(j.transformPoint(new k(h,i,n)));return new k(m[0]+m[2]*(q.x*.5+.5),m[1]+m[3]*(q.y*.5+.5),q.z*.5+.5)},e.unProject=function(h,i,n,j,l,m){j=j||e.modelviewMatrix,l=l||e.projectionMatrix,m=m||e.getParameter(e.VIEWPORT);var q=new k((h-m[0])/m[2]*2-1,(i-m[1])/m[3]*2-1,n*2-1);return p.inverse(p.multiply(l,j,b),c).transformPoint(q)},e.matrixMode(e.MODELVIEW)}function R(){var b={mesh:new w({coords:!0,colors:!0,triangles:!1}),mode:-1,coord:[0,0,0,0],color:[1,1,1,1],pointSize:1,shader:new I("      uniform float pointSize;      varying vec4 color;      varying vec4 coord;      void main() {        color = gl_Color;        coord = gl_TexCoord;        gl_Position = gl_ModelViewProjectionMatrix * gl_Vertex;        gl_PointSize = pointSize;      }    ","      uniform sampler2D texture;      uniform float pointSize;      uniform bool useTexture;      varying vec4 color;      varying vec4 coord;      void main() {        gl_FragColor = color;        if (useTexture) gl_FragColor *= texture2D(texture, coord.xy);      }    ")};e.pointSize=function(c){b.shader.uniforms({pointSize:c})},e.begin=function(c){if(b.mode!=-1)throw new Error("mismatched gl.begin() and gl.end() calls");b.mode=c,b.mesh.colors=[],b.mesh.coords=[],b.mesh.vertices=[]},e.color=function(c,a,d,f){b.color=arguments.length==1?c.toArray().concat(1):[c,a,d,f||1]},e.texCoord=function(c,a){b.coord=arguments.length==1?c.toArray(2):[c,a]},e.vertex=function(c,a,d){b.mesh.colors.push(b.color),b.mesh.coords.push(b.coord),b.mesh.vertices.push(arguments.length==1?c.toArray():[c,a,d])},e.end=function(){if(b.mode==-1)throw new Error("mismatched gl.begin() and gl.end() calls");b.mesh.compile(),b.shader.uniforms({useTexture:!!e.getParameter(e.TEXTURE_BINDING_2D)}).draw(b.mesh,b.mode),b.mode=-1}}function S(){var b=e,c=0,a=0,d={},f=!1,g=Object.prototype.hasOwnProperty;function h(){for(var o in d)if(g.call(d,o)&&d[o])return!0;return!1}function i(o){var r={};for(var s in o)typeof o[s]=="function"?r[s]=function(y){return function(){y.apply(o,arguments)}}(o[s]):r[s]=o[s];r.original=o,r.x=r.pageX,r.y=r.pageY;for(var t=e.canvas;t;t=t.offsetParent)r.x-=t.offsetLeft,r.y-=t.offsetTop;return f?(r.deltaX=r.x-c,r.deltaY=r.y-a):(r.deltaX=0,r.deltaY=0,f=!0),c=r.x,a=r.y,r.dragging=h(),r.preventDefault=function(){r.original.preventDefault()},r.stopPropagation=function(){r.original.stopPropagation()},r}function n(o){e=b,h()||(v(document,"mousemove",j),v(document,"mouseup",l),D(e.canvas,"mousemove",j),D(e.canvas,"mouseup",l)),d[o.which]=!0,o=i(o),e.onmousedown&&e.onmousedown(o),o.preventDefault()}function j(o){e=b,o=i(o),e.onmousemove&&e.onmousemove(o),o.preventDefault()}function l(o){e=b,d[o.which]=!1,h()||(D(document,"mousemove",j),D(document,"mouseup",l),v(e.canvas,"mousemove",j),v(e.canvas,"mouseup",l)),o=i(o),e.onmouseup&&e.onmouseup(o),o.preventDefault()}function m(){f=!1}function q(){d={},f=!1}v(e.canvas,"mousedown",n),v(e.canvas,"mousemove",j),v(e.canvas,"mouseup",l),v(e.canvas,"mouseover",m),v(e.canvas,"mouseout",m),v(document,"contextmenu",q)}function K(b){var c={8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",27:"ESCAPE",32:"SPACE",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"};return c[b]||(b>=65&&b<=90?String.fromCharCode(b):null)}function v(b,c,a){b.addEventListener(c,a)}function D(b,c,a){b.removeEventListener(c,a)}v(document,"keydown",function(b){if(!b.altKey&&!b.ctrlKey&&!b.metaKey){var c=K(b.keyCode);c&&(A.keys[c]=!0),A.keys[b.keyCode]=!0}}),v(document,"keyup",function(b){if(!b.altKey&&!b.ctrlKey&&!b.metaKey){var c=K(b.keyCode);c&&(A.keys[c]=!1),A.keys[b.keyCode]=!1}});function T(){(function(b){e.makeCurrent=function(){e=b}})(e),e.animate=function(){var b=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(f){setTimeout(f,1e3/60)},c=new Date().getTime(),a=e;function d(){e=a;var f=new Date().getTime();e.onupdate&&e.onupdate((f-c)/1e3),e.ondraw&&e.ondraw(),b(d),c=f}d()},e.fullscreen=function(b){b=b||{};var c=b.paddingTop||0,a=b.paddingLeft||0,d=b.paddingRight||0,f=b.paddingBottom||0;if(!document.body)throw new Error("document.body doesn't exist yet (call gl.fullscreen() from window.onload() or from inside the <body> tag)");document.body.appendChild(e.canvas),document.body.style.overflow="hidden",e.canvas.style.position="absolute",e.canvas.style.left=a+"px",e.canvas.style.top=c+"px";function g(){e.canvas.width=window.innerWidth-a-d,e.canvas.height=window.innerHeight-c-f,e.viewport(0,0,e.canvas.width,e.canvas.height),(b.camera||!("camera"in b))&&(e.matrixMode(e.PROJECTION),e.loadIdentity(),e.perspective(b.fov||45,e.canvas.width/e.canvas.height,b.near||.1,b.far||1e3),e.matrixMode(e.MODELVIEW)),e.ondraw&&e.ondraw()}v(window,"resize",g),g()}}var L=305397760,M=typeof Float32Array!="undefined";function p(){var b=Array.prototype.concat.apply([],arguments);b.length||(b=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.m=M?new Float32Array(b):b}p.prototype={inverse:function(){return p.inverse(this,new p())},transpose:function(){return p.transpose(this,new p())},multiply:function(b){return p.multiply(this,b,new p())},transformPoint:function(b){var c=this.m;return new k(c[0]*b.x+c[1]*b.y+c[2]*b.z+c[3],c[4]*b.x+c[5]*b.y+c[6]*b.z+c[7],c[8]*b.x+c[9]*b.y+c[10]*b.z+c[11]).divide(c[12]*b.x+c[13]*b.y+c[14]*b.z+c[15])},transformVector:function(b){var c=this.m;return new k(c[0]*b.x+c[1]*b.y+c[2]*b.z,c[4]*b.x+c[5]*b.y+c[6]*b.z,c[8]*b.x+c[9]*b.y+c[10]*b.z)}},p.inverse=function(b,c){c=c||new p();var a=b.m,d=c.m;d[0]=a[5]*a[10]*a[15]-a[5]*a[14]*a[11]-a[6]*a[9]*a[15]+a[6]*a[13]*a[11]+a[7]*a[9]*a[14]-a[7]*a[13]*a[10],d[1]=-a[1]*a[10]*a[15]+a[1]*a[14]*a[11]+a[2]*a[9]*a[15]-a[2]*a[13]*a[11]-a[3]*a[9]*a[14]+a[3]*a[13]*a[10],d[2]=a[1]*a[6]*a[15]-a[1]*a[14]*a[7]-a[2]*a[5]*a[15]+a[2]*a[13]*a[7]+a[3]*a[5]*a[14]-a[3]*a[13]*a[6],d[3]=-a[1]*a[6]*a[11]+a[1]*a[10]*a[7]+a[2]*a[5]*a[11]-a[2]*a[9]*a[7]-a[3]*a[5]*a[10]+a[3]*a[9]*a[6],d[4]=-a[4]*a[10]*a[15]+a[4]*a[14]*a[11]+a[6]*a[8]*a[15]-a[6]*a[12]*a[11]-a[7]*a[8]*a[14]+a[7]*a[12]*a[10],d[5]=a[0]*a[10]*a[15]-a[0]*a[14]*a[11]-a[2]*a[8]*a[15]+a[2]*a[12]*a[11]+a[3]*a[8]*a[14]-a[3]*a[12]*a[10],d[6]=-a[0]*a[6]*a[15]+a[0]*a[14]*a[7]+a[2]*a[4]*a[15]-a[2]*a[12]*a[7]-a[3]*a[4]*a[14]+a[3]*a[12]*a[6],d[7]=a[0]*a[6]*a[11]-a[0]*a[10]*a[7]-a[2]*a[4]*a[11]+a[2]*a[8]*a[7]+a[3]*a[4]*a[10]-a[3]*a[8]*a[6],d[8]=a[4]*a[9]*a[15]-a[4]*a[13]*a[11]-a[5]*a[8]*a[15]+a[5]*a[12]*a[11]+a[7]*a[8]*a[13]-a[7]*a[12]*a[9],d[9]=-a[0]*a[9]*a[15]+a[0]*a[13]*a[11]+a[1]*a[8]*a[15]-a[1]*a[12]*a[11]-a[3]*a[8]*a[13]+a[3]*a[12]*a[9],d[10]=a[0]*a[5]*a[15]-a[0]*a[13]*a[7]-a[1]*a[4]*a[15]+a[1]*a[12]*a[7]+a[3]*a[4]*a[13]-a[3]*a[12]*a[5],d[11]=-a[0]*a[5]*a[11]+a[0]*a[9]*a[7]+a[1]*a[4]*a[11]-a[1]*a[8]*a[7]-a[3]*a[4]*a[9]+a[3]*a[8]*a[5],d[12]=-a[4]*a[9]*a[14]+a[4]*a[13]*a[10]+a[5]*a[8]*a[14]-a[5]*a[12]*a[10]-a[6]*a[8]*a[13]+a[6]*a[12]*a[9],d[13]=a[0]*a[9]*a[14]-a[0]*a[13]*a[10]-a[1]*a[8]*a[14]+a[1]*a[12]*a[10]+a[2]*a[8]*a[13]-a[2]*a[12]*a[9],d[14]=-a[0]*a[5]*a[14]+a[0]*a[13]*a[6]+a[1]*a[4]*a[14]-a[1]*a[12]*a[6]-a[2]*a[4]*a[13]+a[2]*a[12]*a[5],d[15]=a[0]*a[5]*a[10]-a[0]*a[9]*a[6]-a[1]*a[4]*a[10]+a[1]*a[8]*a[6]+a[2]*a[4]*a[9]-a[2]*a[8]*a[5];for(var f=a[0]*d[0]+a[1]*d[4]+a[2]*d[8]+a[3]*d[12],g=0;g<16;g++)d[g]/=f;return c},p.transpose=function(b,c){c=c||new p();var a=b.m,d=c.m;return d[0]=a[0],d[1]=a[4],d[2]=a[8],d[3]=a[12],d[4]=a[1],d[5]=a[5],d[6]=a[9],d[7]=a[13],d[8]=a[2],d[9]=a[6],d[10]=a[10],d[11]=a[14],d[12]=a[3],d[13]=a[7],d[14]=a[11],d[15]=a[15],c},p.multiply=function(b,c,a){a=a||new p();var d=b.m,f=c.m,g=a.m;return g[0]=d[0]*f[0]+d[1]*f[4]+d[2]*f[8]+d[3]*f[12],g[1]=d[0]*f[1]+d[1]*f[5]+d[2]*f[9]+d[3]*f[13],g[2]=d[0]*f[2]+d[1]*f[6]+d[2]*f[10]+d[3]*f[14],g[3]=d[0]*f[3]+d[1]*f[7]+d[2]*f[11]+d[3]*f[15],g[4]=d[4]*f[0]+d[5]*f[4]+d[6]*f[8]+d[7]*f[12],g[5]=d[4]*f[1]+d[5]*f[5]+d[6]*f[9]+d[7]*f[13],g[6]=d[4]*f[2]+d[5]*f[6]+d[6]*f[10]+d[7]*f[14],g[7]=d[4]*f[3]+d[5]*f[7]+d[6]*f[11]+d[7]*f[15],g[8]=d[8]*f[0]+d[9]*f[4]+d[10]*f[8]+d[11]*f[12],g[9]=d[8]*f[1]+d[9]*f[5]+d[10]*f[9]+d[11]*f[13],g[10]=d[8]*f[2]+d[9]*f[6]+d[10]*f[10]+d[11]*f[14],g[11]=d[8]*f[3]+d[9]*f[7]+d[10]*f[11]+d[11]*f[15],g[12]=d[12]*f[0]+d[13]*f[4]+d[14]*f[8]+d[15]*f[12],g[13]=d[12]*f[1]+d[13]*f[5]+d[14]*f[9]+d[15]*f[13],g[14]=d[12]*f[2]+d[13]*f[6]+d[14]*f[10]+d[15]*f[14],g[15]=d[12]*f[3]+d[13]*f[7]+d[14]*f[11]+d[15]*f[15],a},p.identity=function(b){b=b||new p();var c=b.m;return c[0]=c[5]=c[10]=c[15]=1,c[1]=c[2]=c[3]=c[4]=c[6]=c[7]=c[8]=c[9]=c[11]=c[12]=c[13]=c[14]=0,b},p.perspective=function(b,c,a,d,f){var g=Math.tan(b*Math.PI/360)*a,h=g*c;return p.frustum(-h,h,-g,g,a,d,f)},p.frustum=function(b,c,a,d,f,g,h){h=h||new p();var i=h.m;return i[0]=2*f/(c-b),i[1]=0,i[2]=(c+b)/(c-b),i[3]=0,i[4]=0,i[5]=2*f/(d-a),i[6]=(d+a)/(d-a),i[7]=0,i[8]=0,i[9]=0,i[10]=-(g+f)/(g-f),i[11]=-2*g*f/(g-f),i[12]=0,i[13]=0,i[14]=-1,i[15]=0,h},p.ortho=function(b,c,a,d,f,g,h){h=h||new p();var i=h.m;return i[0]=2/(c-b),i[1]=0,i[2]=0,i[3]=-(c+b)/(c-b),i[4]=0,i[5]=2/(d-a),i[6]=0,i[7]=-(d+a)/(d-a),i[8]=0,i[9]=0,i[10]=-2/(g-f),i[11]=-(g+f)/(g-f),i[12]=0,i[13]=0,i[14]=0,i[15]=1,h},p.scale=function(b,c,a,d){d=d||new p();var f=d.m;return f[0]=b,f[1]=0,f[2]=0,f[3]=0,f[4]=0,f[5]=c,f[6]=0,f[7]=0,f[8]=0,f[9]=0,f[10]=a,f[11]=0,f[12]=0,f[13]=0,f[14]=0,f[15]=1,d},p.translate=function(b,c,a,d){d=d||new p();var f=d.m;return f[0]=1,f[1]=0,f[2]=0,f[3]=b,f[4]=0,f[5]=1,f[6]=0,f[7]=c,f[8]=0,f[9]=0,f[10]=1,f[11]=a,f[12]=0,f[13]=0,f[14]=0,f[15]=1,d},p.rotate=function(b,c,a,d,f){if(!b||!c&&!a&&!d)return p.identity(f);f=f||new p();var g=f.m,h=Math.sqrt(c*c+a*a+d*d);b*=Math.PI/180,c/=h,a/=h,d/=h;var i=Math.cos(b),n=Math.sin(b),j=1-i;return g[0]=c*c*j+i,g[1]=c*a*j-d*n,g[2]=c*d*j+a*n,g[3]=0,g[4]=a*c*j+d*n,g[5]=a*a*j+i,g[6]=a*d*j-c*n,g[7]=0,g[8]=d*c*j-a*n,g[9]=d*a*j+c*n,g[10]=d*d*j+i,g[11]=0,g[12]=0,g[13]=0,g[14]=0,g[15]=1,f},p.lookAt=function(b,c,a,d,f,g,h,i,n,j){j=j||new p();var l=j.m,m=new k(b,c,a),q=new k(d,f,g),o=new k(h,i,n),r=m.subtract(q).unit(),s=o.cross(r).unit(),t=r.cross(s).unit();return l[0]=s.x,l[1]=s.y,l[2]=s.z,l[3]=-s.dot(m),l[4]=t.x,l[5]=t.y,l[6]=t.z,l[7]=-t.dot(m),l[8]=r.x,l[9]=r.y,l[10]=r.z,l[11]=-r.dot(m),l[12]=0,l[13]=0,l[14]=0,l[15]=1,j};function E(){this.unique=[],this.indices=[],this.map={}}E.prototype={add:function(b){var c=JSON.stringify(b);return c in this.map||(this.map[c]=this.unique.length,this.unique.push(b)),this.map[c]}};function F(b,c){this.buffer=null,this.target=b,this.type=c,this.data=[]}F.prototype={compile:function(b){for(var c=[],a=0,d=1e4;a<this.data.length;a+=d)c=Array.prototype.concat.apply(c,this.data.slice(a,a+d));var f=this.data.length?c.length/this.data.length:0;if(f!=Math.round(f))throw new Error("buffer elements not of consistent size, average size is "+f);this.buffer=this.buffer||e.createBuffer(),this.buffer.length=c.length,this.buffer.spacing=f,e.bindBuffer(this.target,this.buffer),e.bufferData(this.target,new this.type(c),b||e.STATIC_DRAW)}};function w(b){b=b||{},this.vertexBuffers={},this.indexBuffers={},this.addVertexBuffer("vertices","gl_Vertex"),b.coords&&this.addVertexBuffer("coords","gl_TexCoord"),b.normals&&this.addVertexBuffer("normals","gl_Normal"),b.colors&&this.addVertexBuffer("colors","gl_Color"),(!("triangles"in b)||b.triangles)&&this.addIndexBuffer("triangles"),b.lines&&this.addIndexBuffer("lines")}w.prototype={addVertexBuffer:function(b,c){var a=this.vertexBuffers[c]=new F(e.ARRAY_BUFFER,Float32Array);a.name=b,this[b]=[]},addIndexBuffer:function(b){var c=this.indexBuffers[b]=new F(e.ELEMENT_ARRAY_BUFFER,Uint16Array);this[b]=[]},compile:function(){for(var b in this.vertexBuffers){var c=this.vertexBuffers[b];c.data=this[c.name],c.compile()}for(var a in this.indexBuffers){var c=this.indexBuffers[a];c.data=this[a],c.compile()}},transform:function(b){this.vertices=this.vertices.map(function(a){return b.transformPoint(k.fromArray(a)).toArray()});if(this.normals){var c=b.inverse().transpose();this.normals=this.normals.map(function(a){return c.transformVector(k.fromArray(a)).unit().toArray()})}return this.compile(),this},computeNormals:function(){this.normals||this.addVertexBuffer("normals","gl_Normal");for(var b=0;b<this.vertices.length;b++)this.normals[b]=new k();for(var b=0;b<this.triangles.length;b++){var c=this.triangles[b],a=k.fromArray(this.vertices[c[0]]),d=k.fromArray(this.vertices[c[1]]),f=k.fromArray(this.vertices[c[2]]),g=d.subtract(a).cross(f.subtract(a)).unit();this.normals[c[0]]=this.normals[c[0]].add(g),this.normals[c[1]]=this.normals[c[1]].add(g),this.normals[c[2]]=this.normals[c[2]].add(g)}for(var b=0;b<this.vertices.length;b++)this.normals[b]=this.normals[b].unit().toArray();return this.compile(),this},computeWireframe:function(){for(var b=new E(),c=0;c<this.triangles.length;c++)for(var a=this.triangles[c],d=0;d<a.length;d++){var f=a[d],g=a[(d+1)%a.length];b.add([Math.min(f,g),Math.max(f,g)])}return this.lines||this.addIndexBuffer("lines"),this.lines=b.unique,this.compile(),this},getAABB:function(){var b={min:new k(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)};b.max=b.min.negative();for(var c=0;c<this.vertices.length;c++){var a=k.fromArray(this.vertices[c]);b.min=k.min(b.min,a),b.max=k.max(b.max,a)}return b},getBoundingSphere:function(){for(var b=this.getAABB(),c={center:b.min.add(b.max).divide(2),radius:0},a=0;a<this.vertices.length;a++)c.radius=Math.max(c.radius,k.fromArray(this.vertices[a]).subtract(c.center).length());return c}},w.plane=function(b){b=b||{};var c=new w(b);detailX=b.detailX||b.detail||1,detailY=b.detailY||b.detail||1;for(var a=0;a<=detailY;a++)for(var d=a/detailY,f=0;f<=detailX;f++){var g=f/detailX;c.vertices.push([2*g-1,2*d-1,0]),c.coords&&c.coords.push([g,d]),c.normals&&c.normals.push([0,0,1]);if(f<detailX&&a<detailY){var h=f+a*(detailX+1);c.triangles.push([h,h+1,h+detailX+1]),c.triangles.push([h+detailX+1,h+1,h+detailX+2])}}return c.compile(),c};var N=[[0,4,2,6,-1,0,0],[1,3,5,7,1,0,0],[0,1,4,5,0,-1,0],[2,6,3,7,0,1,0],[0,2,1,3,0,0,-1],[4,5,6,7,0,0,1]];function O(b){return new k((b&1)*2-1,(b&2)-1,(b&4)/2-1)}w.cube=function(b){for(var c=new w(b),a=0;a<N.length;a++){for(var d=N[a],f=a*4,g=0;g<4;g++){var h=d[g];c.vertices.push(O(h).toArray()),c.coords&&c.coords.push([g&1,(g&2)/2]),c.normals&&c.normals.push(d.slice(4,7))}c.triangles.push([f,f+1,f+2]),c.triangles.push([f+2,f+1,f+3])}return c.compile(),c},w.sphere=function(b){function c(s,t,y){return i?[s,y,t]:[s,t,y]}function a(s){return s+(s-s*s)/2}b=b||{};var d=new w(b),f=new E();detail=b.detail||6;for(var g=0;g<8;g++)for(var h=O(g),i=h.x*h.y*h.z>0,n=[],j=0;j<=detail;j++){for(var l=0;j+l<=detail;l++){var m=j/detail,q=l/detail,o=(detail-j-l)/detail,r={vertex:new k(a(m),a(q),a(o)).unit().multiply(h).toArray()};d.coords&&(r.coord=h.y>0?[1-m,o]:[o,1-m]),n.push(f.add(r))}if(j>0)for(var l=0;j+l<=detail;l++){var m=(j-1)*(detail+1)+(j-1-(j-1)*(j-1))/2+l,q=j*(detail+1)+(j-j*j)/2+l;d.triangles.push(c(n[m],n[m+1],n[q])),j+l<detail&&d.triangles.push(c(n[q],n[m+1],n[q+1]))}}return d.vertices=f.unique.map(function(s){return s.vertex}),d.coords&&(d.coords=f.unique.map(function(s){return s.coord})),d.normals&&(d.normals=d.vertices),d.compile(),d},w.load=function(b,c){c=c||{},"coords"in c||(c.coords=!!b.coords),"normals"in c||(c.normals=!!b.normals),"colors"in c||(c.colors=!!b.colors),"triangles"in c||(c.triangles=!!b.triangles),"lines"in c||(c.lines=!!b.lines);var a=new w(c);return a.vertices=b.vertices,a.coords&&(a.coords=b.coords),a.normals&&(a.normals=b.normals),a.colors&&(a.colors=b.colors),a.triangles&&(a.triangles=b.triangles),a.lines&&(a.lines=b.lines),a.compile(),a};function B(b,c,a){this.t=arguments.length?b:Number.MAX_VALUE,this.hit=c,this.normal=a}B.prototype={mergeWith:function(b){b.t>0&&b.t<this.t&&(this.t=b.t,this.hit=b.hit,this.normal=b.normal)}};function C(){var b=e.getParameter(e.VIEWPORT),c=e.modelviewMatrix.m,a=new k(c[0],c[4],c[8]),d=new k(c[1],c[5],c[9]),f=new k(c[2],c[6],c[10]),g=new k(c[3],c[7],c[11]);this.eye=new k(-g.dot(a),-g.dot(d),-g.dot(f));var h=b[0],i=h+b[2],n=b[1],j=n+b[3];this.ray00=e.unProject(h,n,1).subtract(this.eye),this.ray10=e.unProject(i,n,1).subtract(this.eye),this.ray01=e.unProject(h,j,1).subtract(this.eye),this.ray11=e.unProject(i,j,1).subtract(this.eye),this.viewport=b}C.prototype={getRayForPixel:function(b,c){b=(b-this.viewport[0])/this.viewport[2],c=1-(c-this.viewport[1])/this.viewport[3];var a=k.lerp(this.ray00,this.ray10,b),d=k.lerp(this.ray01,this.ray11,b);return k.lerp(a,d,c).unit()}},C.hitTestBox=function(b,c,a,d){var f=a.subtract(b).divide(c),g=d.subtract(b).divide(c),h=k.min(f,g),i=k.max(f,g),n=h.max(),j=i.min();if(n>0&&n<j){var l=1e-6,m=b.add(c.multiply(n));return a=a.add(l),d=d.subtract(l),new B(n,m,new k((m.x>d.x)-(m.x<a.x),(m.y>d.y)-(m.y<a.y),(m.z>d.z)-(m.z<a.z)))}return null},C.hitTestSphere=function(b,c,a,d){var f=b.subtract(a),g=c.dot(c),h=2*c.dot(f),i=f.dot(f)-d*d,n=h*h-4*g*i;if(n>0){var j=(-h-Math.sqrt(n))/(2*g),l=b.add(c.multiply(j));return new B(j,l,l.subtract(a).divide(d))}return null},C.hitTestTriangle=function(b,c,a,d,f){var g=d.subtract(a),h=f.subtract(a),i=g.cross(h).unit(),n=i.dot(a.subtract(b))/i.dot(c);if(n>0){var j=b.add(c.multiply(n)),l=j.subtract(a),m=h.dot(h),q=h.dot(g),o=h.dot(l),r=g.dot(g),s=g.dot(l),t=m*r-q*q,y=(r*o-q*s)/t,P=(m*s-q*o)/t;if(y>=0&&P>=0&&y+P<=1)return new B(n,j,i)}return null};function H(b,c,a){for(;(result=b.exec(c))!=null;)a(result)}var G="LIGHTGL";function I(b,c){function a(m){var q=document.getElementById(m);return q?q.text:m}b=a(b),c=a(c);var d="    uniform mat3 gl_NormalMatrix;    uniform mat4 gl_ModelViewMatrix;    uniform mat4 gl_ProjectionMatrix;    uniform mat4 gl_ModelViewProjectionMatrix;    uniform mat4 gl_ModelViewMatrixInverse;    uniform mat4 gl_ProjectionMatrixInverse;    uniform mat4 gl_ModelViewProjectionMatrixInverse;  ",f=d+"    attribute vec4 gl_Vertex;    attribute vec4 gl_TexCoord;    attribute vec3 gl_Normal;    attribute vec4 gl_Color;    vec4 ftransform() {      return gl_ModelViewProjectionMatrix * gl_Vertex;    }  ",g="    precision highp float;  "+d,h=b+c,i={};H(/\b(gl_[^;]*)\b;/g,d,function(m){var q=m[1];if(h.indexOf(q)!=-1){var o=q.replace(/[a-z_]/g,"");i[o]=G+q}}),h.indexOf("ftransform")!=-1&&(i.MVPM=G+"gl_ModelViewProjectionMatrix"),this.usedMatrices=i;function n(m,q){var o={},r=/^((\s*\/\/.*\n|\s*#extension.*\n)+)[^]*$/.exec(q);return q=r?r[1]+m+q.substr(r[1].length):m+q,H(/\bgl_\w+\b/g,m,function(s){s in o||(q=q.replace(new RegExp("\\b"+s+"\\b","g"),G+s),o[s]=!0)}),q}b=n(f,b),c=n(g,c);function j(m,q){var o=e.createShader(m);e.shaderSource(o,q),e.compileShader(o);if(!e.getShaderParameter(o,e.COMPILE_STATUS))throw new Error("compile error: "+e.getShaderInfoLog(o));return o}this.program=e.createProgram(),e.attachShader(this.program,j(e.VERTEX_SHADER,b)),e.attachShader(this.program,j(e.FRAGMENT_SHADER,c)),e.linkProgram(this.program);if(!e.getProgramParameter(this.program,e.LINK_STATUS))throw new Error("link error: "+e.getProgramInfoLog(this.program));this.attributes={},this.uniformLocations={};var l={};H(/uniform\s+sampler(1D|2D|3D|Cube)\s+(\w+)\s*;/g,b+c,function(m){l[m[2]]=1}),this.isSampler=l}function U(b){var c=Object.prototype.toString.call(b);return c=="[object Array]"||c=="[object Float32Array]"}function V(b){var c=Object.prototype.toString.call(b);return c=="[object Number]"||c=="[object Boolean]"}var W=new p(),X=new p();I.prototype={uniforms:function(b){e.useProgram(this.program);for(var c in b){var a=this.uniformLocations[c]||e.getUniformLocation(this.program,c);if(!a)continue;this.uniformLocations[c]=a;var d=b[c];d instanceof k?d=[d.x,d.y,d.z]:d instanceof p&&(d=d.m);if(U(d))switch(d.length){case 1:e.uniform1fv(a,new Float32Array(d));break;case 2:e.uniform2fv(a,new Float32Array(d));break;case 3:e.uniform3fv(a,new Float32Array(d));break;case 4:e.uniform4fv(a,new Float32Array(d));break;case 9:e.uniformMatrix3fv(a,!1,new Float32Array([d[0],d[3],d[6],d[1],d[4],d[7],d[2],d[5],d[8]]));break;case 16:e.uniformMatrix4fv(a,!1,new Float32Array([d[0],d[4],d[8],d[12],d[1],d[5],d[9],d[13],d[2],d[6],d[10],d[14],d[3],d[7],d[11],d[15]]));break;default:throw new Error(`don't know how to load uniform "`+c+'" of length '+d.length)}else if(V(d))(this.isSampler[c]?e.uniform1i:e.uniform1f).call(e,a,d);else throw new Error('attempted to set uniform "'+c+'" to invalid value '+d)}return this},draw:function(b,c){this.drawBuffers(b.vertexBuffers,b.indexBuffers[c==e.LINES?"lines":"triangles"],arguments.length<2?e.TRIANGLES:c)},drawBuffers:function(b,c,a){var d=this.usedMatrices,f=e.modelviewMatrix,g=e.projectionMatrix,h=d.MVMI||d.NM?f.inverse():null,i=d.PMI?g.inverse():null,n=d.MVPM||d.MVPMI?g.multiply(f):null,j={};d.MVM&&(j[d.MVM]=f),d.MVMI&&(j[d.MVMI]=h),d.PM&&(j[d.PM]=g),d.PMI&&(j[d.PMI]=i),d.MVPM&&(j[d.MVPM]=n),d.MVPMI&&(j[d.MVPMI]=n.inverse());if(d.NM){var l=h.m;j[d.NM]=[l[0],l[4],l[8],l[1],l[5],l[9],l[2],l[6],l[10]]}this.uniforms(j);var m=0;for(var q in b){var o=b[q],r=this.attributes[q]||e.getAttribLocation(this.program,q.replace(/^(gl_.*)$/,G+"$1"));if(r==-1||!o.buffer)continue;this.attributes[q]=r,e.bindBuffer(e.ARRAY_BUFFER,o.buffer),e.enableVertexAttribArray(r),e.vertexAttribPointer(r,o.buffer.spacing,e.FLOAT,!1,0,0),m=o.buffer.length/o.buffer.spacing}for(var q in this.attributes)q in b||e.disableVertexAttribArray(this.attributes[q]);return m&&(!c||c.buffer)&&(c?(e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,c.buffer),e.drawElements(a,c.buffer.length,e.UNSIGNED_SHORT,0)):e.drawArrays(a,0,m)),this}};function u(b,c,a){a=a||{},this.id=e.createTexture(),this.width=b,this.height=c,this.format=a.format||e.RGBA,this.type=a.type||e.UNSIGNED_BYTE;var d=a.filter||a.magFilter||e.LINEAR,f=a.filter||a.minFilter||e.LINEAR;if(this.type===e.FLOAT){if(!u.canUseFloatingPointTextures())throw new Error("OES_texture_float is required but not supported");if((f!==e.NEAREST||d!==e.NEAREST)&&!u.canUseFloatingPointLinearFiltering())throw new Error("OES_texture_float_linear is required but not supported")}else if(this.type===e.HALF_FLOAT_OES){if(!u.canUseHalfFloatingPointTextures())throw new Error("OES_texture_half_float is required but not supported");if((f!==e.NEAREST||d!==e.NEAREST)&&!u.canUseHalfFloatingPointLinearFiltering())throw new Error("OES_texture_half_float_linear is required but not supported")}e.bindTexture(e.TEXTURE_2D,this.id),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,1),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,d),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,f),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,a.wrap||a.wrapS||e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,a.wrap||a.wrapT||e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,this.format,b,c,0,this.format,this.type,null)}var z,x,J;u.prototype={bind:function(b){e.activeTexture(e.TEXTURE0+(b||0)),e.bindTexture(e.TEXTURE_2D,this.id)},unbind:function(b){e.activeTexture(e.TEXTURE0+(b||0)),e.bindTexture(e.TEXTURE_2D,null)},canDrawTo:function(){z=z||e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,z),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.id,0);var b=e.checkFramebufferStatus(e.FRAMEBUFFER)==e.FRAMEBUFFER_COMPLETE;return e.bindFramebuffer(e.FRAMEBUFFER,null),b},drawTo:function(b){var c=e.getParameter(e.VIEWPORT);z=z||e.createFramebuffer(),x=x||e.createRenderbuffer(),e.bindFramebuffer(e.FRAMEBUFFER,z),e.bindRenderbuffer(e.RENDERBUFFER,x),(this.width!=x.width||this.height!=x.height)&&(x.width=this.width,x.height=this.height,e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,this.width,this.height)),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.id,0),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,x);if(e.checkFramebufferStatus(e.FRAMEBUFFER)!=e.FRAMEBUFFER_COMPLETE)throw new Error("Rendering to this texture is not supported (incomplete framebuffer)");e.viewport(0,0,this.width,this.height),b(),e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindRenderbuffer(e.RENDERBUFFER,null),e.viewport(c[0],c[1],c[2],c[3])},swapWith:function(b){var c;c=b.id,b.id=this.id,this.id=c,c=b.width,b.width=this.width,this.width=c,c=b.height,b.height=this.height,this.height=c}},u.fromImage=function(b,c){c=c||{};var a=new u(b.width,b.height,c);try{e.texImage2D(e.TEXTURE_2D,0,a.format,a.format,a.type,b)}catch(d){throw location.protocol=="file:"?new Error('image not loaded for security reasons (serve this page over "http://" instead)'):new Error("image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)")}return c.minFilter&&c.minFilter!=e.NEAREST&&c.minFilter!=e.LINEAR&&e.generateMipmap(e.TEXTURE_2D),a},u.fromURL=function(b,c){J=J||function(){var g=document.createElement("canvas").getContext("2d");g.canvas.width=g.canvas.height=128;for(var h=0;h<g.canvas.height;h+=16)for(var i=0;i<g.canvas.width;i+=16)g.fillStyle=(i^h)&16?"#FFF":"#DDD",g.fillRect(i,h,16,16);return g.canvas}();var a=u.fromImage(J,c),d=new Image(),f=e;return d.onload=function(){f.makeCurrent(),u.fromImage(d,c).swapWith(a)},d.src=b,a},u.canUseFloatingPointTextures=function(){return!!e.getExtension("OES_texture_float")},u.canUseFloatingPointLinearFiltering=function(){return!!e.getExtension("OES_texture_float_linear")},u.canUseHalfFloatingPointTextures=function(){return!!e.getExtension("OES_texture_half_float")},u.canUseHalfFloatingPointLinearFiltering=function(){return!!e.getExtension("OES_texture_half_float_linear")};function k(b,c,a){this.x=b||0,this.y=c||0,this.z=a||0}return k.prototype={negative:function(){return new k(-this.x,-this.y,-this.z)},add:function(b){return b instanceof k?new k(this.x+b.x,this.y+b.y,this.z+b.z):new k(this.x+b,this.y+b,this.z+b)},subtract:function(b){return b instanceof k?new k(this.x-b.x,this.y-b.y,this.z-b.z):new k(this.x-b,this.y-b,this.z-b)},multiply:function(b){return b instanceof k?new k(this.x*b.x,this.y*b.y,this.z*b.z):new k(this.x*b,this.y*b,this.z*b)},divide:function(b){return b instanceof k?new k(this.x/b.x,this.y/b.y,this.z/b.z):new k(this.x/b,this.y/b,this.z/b)},equals:function(b){return this.x==b.x&&this.y==b.y&&this.z==b.z},dot:function(b){return this.x*b.x+this.y*b.y+this.z*b.z},cross:function(b){return new k(this.y*b.z-this.z*b.y,this.z*b.x-this.x*b.z,this.x*b.y-this.y*b.x)},length:function(){return Math.sqrt(this.dot(this))},unit:function(){return this.divide(this.length())},min:function(){return Math.min(Math.min(this.x,this.y),this.z)},max:function(){return Math.max(Math.max(this.x,this.y),this.z)},toAngles:function(){return{theta:Math.atan2(this.z,this.x),phi:Math.asin(this.y/this.length())}},angleTo:function(b){return Math.acos(this.dot(b)/(this.length()*b.length()))},toArray:function(b){return[this.x,this.y,this.z].slice(0,b||3)},clone:function(){return new k(this.x,this.y,this.z)},init:function(b,c,a){return this.x=b,this.y=c,this.z=a,this}},k.negative=function(b,c){return c.x=-b.x,c.y=-b.y,c.z=-b.z,c},k.add=function(b,c,a){return c instanceof k?(a.x=b.x+c.x,a.y=b.y+c.y,a.z=b.z+c.z):(a.x=b.x+c,a.y=b.y+c,a.z=b.z+c),a},k.subtract=function(b,c,a){return c instanceof k?(a.x=b.x-c.x,a.y=b.y-c.y,a.z=b.z-c.z):(a.x=b.x-c,a.y=b.y-c,a.z=b.z-c),a},k.multiply=function(b,c,a){return c instanceof k?(a.x=b.x*c.x,a.y=b.y*c.y,a.z=b.z*c.z):(a.x=b.x*c,a.y=b.y*c,a.z=b.z*c),a},k.divide=function(b,c,a){return c instanceof k?(a.x=b.x/c.x,a.y=b.y/c.y,a.z=b.z/c.z):(a.x=b.x/c,a.y=b.y/c,a.z=b.z/c),a},k.cross=function(b,c,a){return a.x=b.y*c.z-b.z*c.y,a.y=b.z*c.x-b.x*c.z,a.z=b.x*c.y-b.y*c.x,a},k.unit=function(b,c){var a=b.length();return c.x=b.x/a,c.y=b.y/a,c.z=b.z/a,c},k.fromAngles=function(b,c){return new k(Math.cos(b)*Math.cos(c),Math.sin(c),Math.sin(b)*Math.cos(c))},k.randomDirection=function(){return k.fromAngles(Math.random()*Math.PI*2,Math.asin(Math.random()*2-1))},k.min=function(b,c){return new k(Math.min(b.x,c.x),Math.min(b.y,c.y),Math.min(b.z,c.z))},k.max=function(b,c){return new k(Math.max(b.x,c.x),Math.max(b.y,c.y),Math.max(b.z,c.z))},k.lerp=function(b,c,a){return c.subtract(b).multiply(a).add(b)},k.fromArray=function(b){return new k(b[0],b[1],b[2])},k.angleBetween=function(b,c){return b.angleTo(c)},A}();
